"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Model = void 0;

var _collection = require("./collection");

var _hasEvent = require("./has-event");

var _db = require("./db");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Model extends _hasEvent.HasEvent {
  constructor(data) {
    super();

    _defineProperty(this, "fillables", void 0);

    _defineProperty(this, "data", {});

    _defineProperty(this, "type", Model);

    this.booting();
    this.fillables = this.fillable();

    if (!this.name || this.name.length === 0) {
      this.name = this.constructor.name.toLowerCase();
    }

    if (!('id' in this.data)) {
      this.data.id === '';
    }

    if (data !== undefined) {
      this.fill(data);
    }

    this.booted();
  }

  static createQueryBuilder() {
    return new this();
  }

  fillable() {
    return [];
  }

  booting() {}

  booted() {}

  entries() {
    return Object.entries(this.getData());
  }

  values() {
    return Object.values(this.getData());
  }

  keys() {
    return Object.keys(this.getData());
  }

  getTableName() {
    return this.name;
  }

  toJSON() {
    return this.getData();
  }

  toRawData() {
    return _objectSpread({}, this.data);
  }

  static make(data) {
    return new this(data);
  }

  async paginate(page, perPage) {
    try {
      let collection = this.getCollection();
      this.queries.forEach(query => {
        switch (query.method) {
          case 'where':
            const {
              operator,
              value
            } = query;
            collection = collection.where(query.key, operator, value);
            break;

          case 'whereIn':
            const {
              values
            } = query;
            values.forEach(value => {
              collection = collection.where(query.key, '==', value);
            });
            break;

          case 'whereNotIn':
            query.values.forEach(value => {
              collection = collection.where(query.key, '!=', value);
            });
            break;

          case 'limit':
            collection = collection.limit(query.amount);
            break;
        }
      });
      const snapshot = await collection.orderBy('id').startAt(perPage * (page - 1)).limit(perPage).get();
      const data = new _collection.Collection();
      snapshot.forEach(document => {
        const body = _objectSpread(_objectSpread({}, document.data()), {}, {
          id: document.id
        });

        const instance = new this.type();
        instance.forceFill(body);
        data.push(instance);
      });
      return data;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  async findOne(id) {
    try {
      const document = await this.getCollection().doc(id).get();

      if (!document.exists) {
        return null;
      }

      const body = _objectSpread(_objectSpread({}, document.data()), {}, {
        id: document.id
      });

      this.forceFill(body);
      return this;
    } catch (error) {
      console.error(error);
      return null;
    } finally {
      this.clearQueries();
    }
  }

  async findOneOrFail(id) {
    const model = await this.findOne(id);

    if (!model) {
      throw new Error('Model does not exist.');
    }

    return model;
  }

  getCollection() {
    return (0, _db.makeCollection)(this.getTableName());
  }

  fill(data) {
    for (const [key, value] of Object.entries(data)) {
      if (this.fillables.find(filler => filler === key) !== undefined || this.fillables.includes(key)) {
        this.set(key, value);
      }
    }

    return this;
  }

  forceFill(data) {
    for (const [key, value] of Object.entries(data)) {
      this.set(key, value);
    }

    return this;
  }

  async count() {
    const collection = await this.all();
    return collection.length;
  }

  async delete() {
    try {
      this.callEvent('deleting');
      let collection = this.getCollection();
      await collection.doc(this.id()).delete();
      this.callEvent('deleted');
      return;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  set(key, value) {
    this.data[key] = value;
    return this;
  }

  get(key) {
    if (!(key in this.data)) {
      return null;
    }

    const value = this.data[key];

    if (value instanceof Model) {
      return value.getData();
    } else if (value instanceof _collection.Collection) {
      return value.toJSON();
    } else if (Array.isArray(value)) {
      return value.map(item => {
        if (item instanceof Model) {
          return item.getData();
        }

        return item;
      });
    }

    return value;
  }

  getData() {
    const data = {};

    for (const key in this.data) {
      const value = this.data[key];

      if (value instanceof Model) {
        data[key] = value.getData();
      } else if (value instanceof _collection.Collection) {
        data[key] = value.toJSON();
      } else if (Array.isArray(value)) {
        data[key] = value.map(item => {
          if (item instanceof Model) {
            return item.getData();
          }

          return item;
        });
      } else {
        data[key] = value;
      }
    }

    return data;
  }

  async first() {
    const collection = await this.limit(1).getAll();

    if (collection.length > 0) {
      return collection[0];
    }

    return null;
  }

  async firstOrFail() {
    const item = await this.first();

    if (!item) {
      throw new Error('Model does not exist.');
    }

    return item;
  }

  async getAll() {
    try {
      let collection = this.getCollection();
      this.queries.forEach(query => {
        switch (query.method) {
          case 'where':
            const {
              operator,
              value
            } = query;
            collection = collection.where(query.key, operator, value);
            break;

          case 'whereIn':
            const {
              values
            } = query;
            values.forEach(value => {
              collection = collection.where(query.key, '==', value);
            });
            break;

          case 'whereNotIn':
            query.values.forEach(value => {
              collection = collection.where(query.key, '!=', value);
            });
            break;

          case 'limit':
            collection = collection.limit(query.amount);
            break;
        }
      });
      const snapshot = await collection.get();
      const data = new _collection.Collection();
      snapshot.forEach(document => {
        const body = _objectSpread(_objectSpread({}, document.data()), {}, {
          id: document.id
        });

        const instance = new this.type();
        instance.forceFill(body);
        data.push(instance);
      });
      return data;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  withoutRelations() {
    const data = {};

    for (const key in this.data) {
      const value = this.data[key];

      if (value instanceof Model === false && value instanceof _collection.Collection === false) {
        data[key] = value;
      }
    }

    return data;
  }

  async load(relations) {
    const operations = relations.map(relation => this[relation]().get());
    const results = await Promise.all(operations);
    results.forEach((data, index) => {
      const name = relations[index];
      this.set(name, data);
    });
    return this;
  }

  all() {
    return this.getAll();
  }

  async create(data) {
    if (data) {
      this.fill(data);
    }

    this.set('created_at', new Date().toJSON());
    this.set('updated_at', new Date().toJSON());
    this.callEvent('creating').callEvent('saving');
    const ref = this.getCollection().doc();

    const payload = _objectSpread(_objectSpread({}, this.withoutRelations()), {}, {
      id: ref.id
    });

    await ref.set(payload);
    this.forceFill(payload);
    this.callEvent('created').callEvent('saved');
    return this;
  }

  async update(data) {
    if (data) {
      this.fill(data);
    }

    const oldUpdatedAt = this.get('updated_at');

    try {
      this.callEvent('updating').callEvent('saving');
      this.set('updated_at', new Date().toJSON());
      const data = this.withoutRelations();
      await this.getCollection().doc(data.id).set(data);
      this.callEvent('updated').callEvent('saved');
      return this;
    } catch (error) {
      this.set('updated_at', oldUpdatedAt);
      throw error;
    }
  }

  id() {
    return this.get('id');
  }

  save(data) {
    if (data) {
      this.fill(data);
    }

    return this.has('id') ? this.update() : this.create();
  }

  unset(key) {
    delete this.data[key];
    return this;
  }

  has(key) {
    return key in this.data || this.get(key) !== null;
  }

}

exports.Model = Model;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC50cyJdLCJuYW1lcyI6WyJNb2RlbCIsIkhhc0V2ZW50IiwiY29uc3RydWN0b3IiLCJkYXRhIiwiYm9vdGluZyIsImZpbGxhYmxlcyIsImZpbGxhYmxlIiwibmFtZSIsImxlbmd0aCIsInRvTG93ZXJDYXNlIiwiaWQiLCJ1bmRlZmluZWQiLCJmaWxsIiwiYm9vdGVkIiwiY3JlYXRlUXVlcnlCdWlsZGVyIiwiZW50cmllcyIsIk9iamVjdCIsImdldERhdGEiLCJ2YWx1ZXMiLCJrZXlzIiwiZ2V0VGFibGVOYW1lIiwidG9KU09OIiwidG9SYXdEYXRhIiwibWFrZSIsInBhZ2luYXRlIiwicGFnZSIsInBlclBhZ2UiLCJjb2xsZWN0aW9uIiwiZ2V0Q29sbGVjdGlvbiIsInF1ZXJpZXMiLCJmb3JFYWNoIiwicXVlcnkiLCJtZXRob2QiLCJvcGVyYXRvciIsInZhbHVlIiwid2hlcmUiLCJrZXkiLCJsaW1pdCIsImFtb3VudCIsInNuYXBzaG90Iiwib3JkZXJCeSIsInN0YXJ0QXQiLCJnZXQiLCJDb2xsZWN0aW9uIiwiZG9jdW1lbnQiLCJib2R5IiwiaW5zdGFuY2UiLCJ0eXBlIiwiZm9yY2VGaWxsIiwicHVzaCIsImVycm9yIiwiY2xlYXJRdWVyaWVzIiwiZmluZE9uZSIsImRvYyIsImV4aXN0cyIsImNvbnNvbGUiLCJmaW5kT25lT3JGYWlsIiwibW9kZWwiLCJFcnJvciIsImZpbmQiLCJmaWxsZXIiLCJpbmNsdWRlcyIsInNldCIsImNvdW50IiwiYWxsIiwiZGVsZXRlIiwiY2FsbEV2ZW50IiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXRlbSIsImZpcnN0IiwiZ2V0QWxsIiwiZmlyc3RPckZhaWwiLCJ3aXRob3V0UmVsYXRpb25zIiwibG9hZCIsInJlbGF0aW9ucyIsIm9wZXJhdGlvbnMiLCJyZWxhdGlvbiIsInJlc3VsdHMiLCJQcm9taXNlIiwiaW5kZXgiLCJjcmVhdGUiLCJEYXRlIiwicmVmIiwicGF5bG9hZCIsInVwZGF0ZSIsIm9s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QUFLK0QsU0FBTCxDQUFlLFNBQWYsRUFBMEJBLFNBQTFCLENBQW9DLE9BQXBDO0FBQ0EsYUFBTyxJQUFQO0FBQ0EsS0FWRCxDQVVFLE9BQU9oQixLQUFQLEVBQWM7QUFDZixXQUFLWSxHQUFMLENBQVMsWUFBVCxFQUF1QnlCLFlBQXZCO0FBQ0EsWUFBTXJDLEtBQU47QUFDQTtBQUNEOztBQUVEeEMsRUFBQUEsRUFBRSxHQUFHO0FBQ0osV0FBTyxLQUFLZ0MsR0FBTCxDQUFTLElBQVQsQ0FBUDtBQUNBOztBQUVEOEMsRUFBQUEsSUFBSSxDQUFDckYsSUFBRCxFQUFvQjtBQUN2QixRQUFJQSxJQUFKLEVBQVU7QUFDVCxXQUFLUyxJQUFMLENBQVVULElBQVY7QUFDQTs7QUFDRCxXQUFPLEtBQUtzRixHQUFMLENBQVMsSUFBVCxJQUFpQixLQUFLSCxNQUFMLEVBQWpCLEdBQWlDLEtBQUtKLE1BQUwsRUFBeEM7QUFDQTs7QUFFRFEsRUFBQUEsS0FBSyxDQUFvQnRELEdBQXBCLEVBQTRCO0FBQ2hDLFdBQU8sS0FBS2pDLElBQUwsQ0FBVWlDLEdBQVYsQ0FBUDtBQUNBLFdBQU8sSUFBUDtBQUNBOztBQUVEcUQsRUFBQUEsR0FBRyxDQUFvQnJELEdBQXBCLEVBQTRCO0FBQzlCLFdBQU9BLEdBQUcsSUFBSSxLQUFLakMsSUFBWixJQUFvQixLQUFLdUMsR0FBTCxDQUFTTixHQUFULE1BQWtCLElBQTdDO0FBQ0E7O0FBM1lnRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbGxlY3Rpb24gfSBmcm9tICcuL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHsgSGFzRXZlbnQgfSBmcm9tICcuL2hhcy1ldmVudCc7XG5pbXBvcnQgeyBGaXJlc3RvcmVDb2xsZWN0aW9uLCBJbnRlcmFjdHNXaXRoUmVsYXRpb25zaGlwLCBNb2RlbERhdGEgfSBmcm9tICcuL2NvbnRyYWN0cyc7XG5pbXBvcnQgeyBtYWtlQ29sbGVjdGlvbiB9IGZyb20gJy4vZGInO1xuXG5leHBvcnQgY2xhc3MgTW9kZWw8VCBleHRlbmRzIE1vZGVsRGF0YSA9IGFueT4gZXh0ZW5kcyBIYXNFdmVudDxUPiB7XG5cdHByb3RlY3RlZCBmaWxsYWJsZXM6IEFycmF5PHN0cmluZz47XG5cdHByb3RlY3RlZCBkYXRhOiBUID0ge30gYXMgVDtcblx0dHlwZTogYW55ID0gTW9kZWw7XG5cblx0Y29uc3RydWN0b3IoZGF0YT86IFBhcnRpYWw8VD4pIHtcblx0XHRzdXBlcigpO1xuXHRcdHRoaXMuYm9vdGluZygpO1xuXHRcdHRoaXMuZmlsbGFibGVzID0gdGhpcy5maWxsYWJsZSgpO1xuXG5cdFx0aWYgKCF0aGlzLm5hbWUgfHwgdGhpcy5uYW1lLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0dGhpcy5uYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLnRvTG93ZXJDYXNlKCk7XG5cdFx0fVxuXG5cdFx0aWYgKCEoJ2lkJyBpbiB0aGlzLmRhdGEpKSB7XG5cdFx0XHR0aGlzLmRhdGEuaWQgPT09ICcnO1xuXHRcdH1cblx0XHRpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aGlzLmZpbGwoZGF0YSk7XG5cdFx0fVxuXHRcdHRoaXMuYm9vdGVkKCk7XG5cdH1cblxuXHRzdGF0aWMgY3JlYXRlUXVlcnlCdWlsZGVyKCkge1xuXHRcdHJldHVybiBuZXcgdGhpcygpO1xuXHR9XG5cblx0cHJvdGVjdGVkIGZpbGxhYmxlKCk6IEFycmF5PHN0cmluZz4ge1xuXHRcdHJldHVybiBbXTtcblx0fVxuXG5cdHByb3RlY3RlZCBib290aW5nKCkge31cblxuXHRwcm90ZWN0ZWQgYm9vdGVkKCkge31cblxuXHRlbnRyaWVzKCkge1xuXHRcdHJldHVybiBPYmplY3QuZW50cmllcyh0aGlzLmdldERhdGEoKSk7XG5cdH1cblxuXHR2YWx1ZXMoKSB7XG5cdFx0cmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5nZXREYXRhKCkpO1xuXHR9XG5cblx0a2V5cygpIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy5nZXREYXRhKCkpO1xuXHR9XG5cblx0Z2V0VGFibGVOYW1lKCkge1xuXHRcdHJldHVybiB0aGlzLm5hbWU7XG5cdH1cblxuXHR0b0pTT04oKSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0RGF0YSgpO1xuXHR9XG5cblx0dG9SYXdEYXRhKCkge1xuXHRcdHJldHVybiB7IC4uLnRoaXMuZGF0YSB9O1xuXHR9XG5cblx0c3RhdGljIG1ha2UoZGF0YT86IGFueSkge1xuXHRcdHJldHVybiBuZXcgdGhpcyhkYXRhKTtcblx0fVxuXG5cdGFzeW5jIHBhZ2luYXRlKHBhZ2U6IG51bWJlciwgcGVyUGFnZTogbnVtYmVyKTogUHJvbWlzZTxDb2xsZWN0aW9uPHRoaXMsIFQ+PiB7XG5cdFx0dHJ5IHtcblx0XHRcdGxldCBjb2xsZWN0aW9uOiBGaXJlc3RvcmVDb2xsZWN0aW9uID0gdGhpcy5nZXRDb2xsZWN0aW9uKCk7XG5cdFx0XHR0aGlzLnF1ZXJpZXMuZm9yRWFjaCgocXVlcnkpID0+IHtcblx0XHRcdFx0c3dpdGNoIChxdWVyeS5tZXRob2QpIHtcblx0XHRcdFx0XHRjYXNlICd3aGVyZSc6XG5cdFx0XHRcdFx0XHRjb25zdCB7IG9wZXJhdG9yLCB2YWx1ZSB9ID0gcXVlcnk7XG5cdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi53aGVyZShxdWVyeS5rZXksIG9wZXJhdG9yLCB2YWx1ZSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICd3aGVyZUluJzpcblx0XHRcdFx0XHRcdGNvbnN0IHsgdmFsdWVzIH0gPSBxdWVyeTtcblx0XHRcdFx0XHRcdHZhbHVlcy5mb3JFYWNoKCh2YWx1ZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLndoZXJlKHF1ZXJ5LmtleSwgJz09JywgdmFsdWUpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICd3aGVyZU5vdEluJzpcblx0XHRcdFx0XHRcdHF1ZXJ5LnZhbHVlcy5mb3JFYWNoKCh2YWx1ZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLndoZXJlKHF1ZXJ5LmtleSwgJyE9JywgdmFsdWUpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICdsaW1pdCc6XG5cdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi5saW1pdChxdWVyeS5hbW91bnQpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdFx0Y29uc3Qgc25hcHNob3QgPSBhd2FpdCBjb2xsZWN0aW9uXG5cdFx0XHRcdC5vcmRlckJ5KCdpZCcpXG5cdFx0XHRcdC5zdGFydEF0KHBlclBhZ2UgKiAocGFnZSAtIDEpKVxuXHRcdFx0XHQubGltaXQocGVyUGFnZSlcblx0XHRcdFx0LmdldCgpO1xuXG5cdFx0XHRjb25zdCBkYXRhID0gbmV3IENvbGxlY3Rpb24oKTtcblx0XHRcdHNuYXBzaG90LmZvckVhY2goKGRvY3VtZW50KSA9PiB7XG5cdFx0XHRcdGNvbnN0IGJvZHkgPSB7XG5cdFx0XHRcdFx0Li4uZG9jdW1lbnQuZGF0YSgpLFxuXHRcdFx0XHRcdGlkOiBkb2N1bWVudC5pZCxcblx0XHRcdFx0fTtcblx0XHRcdFx0Y29uc3QgaW5zdGFuY2UgPSBuZXcgdGhpcy50eXBlKCk7XG5cdFx0XHRcdGluc3RhbmNlLmZvcmNlRmlsbChib2R5KTtcblx0XHRcdFx0ZGF0YS5wdXNoKGluc3RhbmNlKTtcblx0XHRcdH0pO1xuXHRcdFx0cmV0dXJuIGRhdGE7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRocm93IGVycm9yO1xuXHRcdH0gZmluYWxseSB7XG5cdFx0XHR0aGlzLmNsZWFyUXVlcmllcygpO1xuXHRcdH1cblx0fVxuXG5cdGFzeW5jIGZpbmRPbmUoaWQ6IHN0cmluZyk6IFByb21pc2U8dGhpcyB8IG51bGw+IHtcblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgZG9jdW1lbnQgPSBhd2FpdCB0aGlzLmdldENvbGxlY3Rpb24oKS5kb2MoaWQpLmdldCgpO1xuXG5cdFx0XHRpZiAoIWRvY3VtZW50LmV4aXN0cykge1xuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgYm9keTogYW55ID0ge1xuXHRcdFx0XHQuLi5kb2N1bWVudC5kYXRhKCksXG5cdFx0XHRcdGlkOiBkb2N1bWVudC5pZCxcblx0XHRcdH07XG5cblx0XHRcdHRoaXMuZm9yY2VGaWxsKGJvZHkpO1xuXHRcdFx0cmV0dXJuIHRoaXM7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdHRoaXMuY2xlYXJRdWVyaWVzKCk7XG5cdFx0fVxuXHR9XG5cblx0YXN5bmMgZmluZE9uZU9yRmFpbChpZDogc3RyaW5nKSB7XG5cdFx0Y29uc3QgbW9kZWwgPSBhd2FpdCB0aGlzLmZpbmRPbmUoaWQpO1xuXG5cdFx0aWYgKCFtb2RlbCkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdNb2RlbCBkb2VzIG5vdCBleGlzdC4nKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbW9kZWw7XG5cdH1cblxuXHRnZXRDb2xsZWN0aW9uKCkge1xuXHRcdHJldHVybiBtYWtlQ29sbGVjdGlvbih0aGlzLmdldFRhYmxlTmFtZSgpKTtcblx0fVxuXG5cdGZpbGwoZGF0YTogUGFydGlhbDxUPikge1xuXHRcdGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG5cdFx0XHRpZiAodGhpcy5maWxsYWJsZXMuZmluZCgoZmlsbGVyKSA9PiBmaWxsZXIgPT09IGtleSkgIT09IHVuZGVmaW5lZCB8fCB0aGlzLmZpbGxhYmxlcy5pbmNsdWRlcyhrZXkpKSB7XG5cdFx0XHRcdHRoaXMuc2V0KGtleSBhcyBrZXlvZiBULCB2YWx1ZSk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0Zm9yY2VGaWxsKGRhdGE6IFBhcnRpYWw8VD4pIHtcblx0XHRmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkYXRhKSkge1xuXHRcdFx0dGhpcy5zZXQoa2V5IGFzIGFueSwgdmFsdWUpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGFzeW5jIGNvdW50KCkge1xuXHRcdGNvbnN0IGNvbGxlY3Rpb24gPSBhd2FpdCB0aGlzLmFsbCgpO1xuXHRcdHJldHVybiBjb2xsZWN0aW9uLmxlbmd0aDtcblx0fVxuXG5cdGFzeW5jIGRlbGV0ZSgpIHtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5jYWxsRXZlbnQoJ2RlbGV0aW5nJyk7XG5cdFx0XHRsZXQgY29sbGVjdGlvbiA9IHRoaXMuZ2V0Q29sbGVjdGlvbigpO1xuXHRcdFx0YXdhaXQgY29sbGVjdGlvbi5kb2ModGhpcy5pZCgpKS5kZWxldGUoKTtcblx0XHRcdHRoaXMuY2FsbEV2ZW50KCdkZWxldGVkJyk7XG5cblx0XHRcdHJldHVybjtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdHRoaXMuY2xlYXJRdWVyaWVzKCk7XG5cdFx0fVxuXHR9XG5cblx0c2V0PEsgZXh0ZW5kcyBrZXlvZiBUPihrZXk6IEssIHZhbHVlOiBUW0tdKSB7XG5cdFx0dGhpcy5kYXRhW2tleV0gPSB2YWx1ZTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldDxLIGV4dGVuZHMga2V5b2YgVD4oa2V5OiBLKTogVFtLXSB7XG5cdFx0aWYgKCEoa2V5IGluIHRoaXMuZGF0YSkpIHtcblx0XHRcdHJldHVybiBudWxsIGFzIHVua25vd24gYXMgVFtLXTtcblx0XHR9XG5cdFx0Y29uc3QgdmFsdWUgPSB0aGlzLmRhdGFba2V5XTtcblxuXHRcdGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1vZGVsKSB7XG5cdFx0XHRyZXR1cm4gdmFsdWUuZ2V0RGF0YSgpO1xuXHRcdH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBDb2xsZWN0aW9uKSB7XG5cdFx0XHRyZXR1cm4gdmFsdWUudG9KU09OKCkgYXMgYW55O1xuXHRcdH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcblx0XHRcdHJldHVybiB2YWx1ZS5tYXAoKGl0ZW0pID0+IHtcblx0XHRcdFx0aWYgKGl0ZW0gaW5zdGFuY2VvZiBNb2RlbCkge1xuXHRcdFx0XHRcdHJldHVybiBpdGVtLmdldERhdGEoKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gaXRlbTtcblx0XHRcdH0pIGFzIGFueTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdmFsdWU7XG5cdH1cblxuXHRnZXREYXRhKCk6IFQge1xuXHRcdGNvbnN0IGRhdGE6IGFueSA9IHt9O1xuXG5cdFx0Zm9yIChjb25zdCBrZXkgaW4gdGhpcy5kYXRhKSB7XG5cdFx0XHRjb25zdCB2YWx1ZSA9IHRoaXMuZGF0YVtrZXldO1xuXG5cdFx0XHRpZiAodmFsdWUgaW5zdGFuY2VvZiBNb2RlbCkge1xuXHRcdFx0XHRkYXRhW2tleV0gPSB2YWx1ZS5nZXREYXRhKCk7XG5cdFx0XHR9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ29sbGVjdGlvbikge1xuXHRcdFx0XHRkYXRhW2tleV0gPSB2YWx1ZS50b0pTT04oKTtcblx0XHRcdH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcblx0XHRcdFx0ZGF0YVtrZXldID0gdmFsdWUubWFwKChpdGVtKSA9PiB7XG5cdFx0XHRcdFx0aWYgKGl0ZW0gaW5zdGFuY2VvZiBNb2RlbCkge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGl0ZW0uZ2V0RGF0YSgpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRyZXR1cm4gaXRlbTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRkYXRhW2tleV0gPSB2YWx1ZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gZGF0YTtcblx0fVxuXG5cdGFzeW5jIGZpcnN0KCkge1xuXHRcdGNvbnN0IGNvbGxlY3Rpb24gPSBhd2FpdCB0aGlzLmxpbWl0KDEpLmdldEFsbCgpO1xuXG5cdFx0aWYgKGNvbGxlY3Rpb24ubGVuZ3RoID4gMCkge1xuXHRcdFx0cmV0dXJuIGNvbGxlY3Rpb25bMF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRhc3luYyBmaXJzdE9yRmFpbCgpIHtcblx0XHRjb25zdCBpdGVtID0gYXdhaXQgdGhpcy5maXJzdCgpO1xuXG5cdFx0aWYgKCFpdGVtKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIGRvZXMgbm90IGV4aXN0LicpO1xuXHRcdH1cblxuXHRcdHJldHVybiBpdGVtO1xuXHR9XG5cblx0YXN5bmMgZ2V0QWxsKCk6IFByb21pc2U8Q29sbGVjdGlvbjx0aGlzLCBUPj4ge1xuXHRcdHRyeSB7XG5cdFx0XHRsZXQgY29sbGVjdGlvbjogRmlyZXN0b3JlQ29sbGVjdGlvbiA9IHRoaXMuZ2V0Q29sbGVjdGlvbigpO1xuXHRcdFx0dGhpcy5xdWVyaWVzLmZvckVhY2goKHF1ZXJ5KSA9PiB7XG5cdFx0XHRcdHN3aXRjaCAocXVlcnkubWV0aG9kKSB7XG5cdFx0XHRcdFx0Y2FzZSAnd2hlcmUnOlxuXHRcdFx0XHRcdFx0Y29uc3QgeyBvcGVyYXRvciwgdmFsdWUgfSA9IHF1ZXJ5O1xuXHRcdFx0XHRcdFx0Y29sbGVjdGlvbiA9IGNvbGxlY3Rpb24ud2hlcmUocXVlcnkua2V5LCBvcGVyYXRvciwgdmFsdWUpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAnd2hlcmVJbic6XG5cdFx0XHRcdFx0XHRjb25zdCB7IHZhbHVlcyB9ID0gcXVlcnk7XG5cdFx0XHRcdFx0XHR2YWx1ZXMuZm9yRWFjaCgodmFsdWU6IGFueSkgPT4ge1xuXHRcdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi53aGVyZShxdWVyeS5rZXksICc9PScsIHZhbHVlKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAnd2hlcmVOb3RJbic6XG5cdFx0XHRcdFx0XHRxdWVyeS52YWx1ZXMuZm9yRWFjaCgodmFsdWU6IGFueSkgPT4ge1xuXHRcdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi53aGVyZShxdWVyeS5rZXksICchPScsIHZhbHVlKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0Y2FzZSAnbGltaXQnOlxuXHRcdFx0XHRcdFx0Y29sbGVjdGlvbiA9IGNvbGxlY3Rpb24ubGltaXQocXVlcnkuYW1vdW50KTtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHRcdGNvbnN0IHNuYXBzaG90ID0gYXdhaXQgY29sbGVjdGlvbi5nZXQoKTtcblx0XHRcdGNvbnN0IGRhdGEgPSBuZXcgQ29sbGVjdGlvbigpO1xuXG5cdFx0XHRzbmFwc2hvdC5mb3JFYWNoKChkb2N1bWVudCkgPT4ge1xuXHRcdFx0XHRjb25zdCBib2R5ID0ge1xuXHRcdFx0XHRcdC4uLmRvY3VtZW50LmRhdGEoKSxcblx0XHRcdFx0XHRpZDogZG9jdW1lbnQuaWQsXG5cdFx0XHRcdH07XG5cdFx0XHRcdGNvbnN0IGluc3RhbmNlID0gbmV3IHRoaXMudHlwZSgpO1xuXHRcdFx0XHRpbnN0YW5jZS5mb3JjZUZpbGwoYm9keSk7XG5cdFx0XHRcdGRhdGEucHVzaChpbnN0YW5jZSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0cmV0dXJuIGRhdGE7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRocm93IGVycm9yO1xuXHRcdH0gZmluYWxseSB7XG5cdFx0XHR0aGlzLmNsZWFyUXVlcmllcygpO1xuXHRcdH1cblx0fVxuXG5cdHdpdGhvdXRSZWxhdGlvbnMoKTogVCB7XG5cdFx0Y29uc3QgZGF0YTogYW55ID0ge307XG5cblx0XHRmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmRhdGEpIHtcblx0XHRcdGNvbnN0IHZhbHVlID0gdGhpcy5kYXRhW2tleV07XG5cblx0XHRcdGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1vZGVsID09PSBmYWxzZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIENvbGxlY3Rpb24gPT09IGZhbHNlKSB7XG5cdFx0XHRcdGRhdGFba2V5XSA9IHZhbHVlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBkYXRhO1xuXHR9XG5cblx0YXN5bmMgbG9hZChyZWxhdGlvbnM6IEFycmF5PHN0cmluZz4pIHtcblx0XHRjb25zdCBvcGVyYXRpb25zID0gcmVsYXRpb25zLm1hcCgocmVsYXRpb24pID0+ICgodGhpcyBhcyBhbnkpW3JlbGF0aW9uXSgpIGFzIEludGVyYWN0c1dpdGhSZWxhdGlvbnNoaXA8dGhpcz4pLmdldCgpKTtcblx0XHRjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwob3BlcmF0aW9ucyk7XG5cdFx0cmVzdWx0cy5mb3JFYWNoKChkYXRhLCBpbmRleCkgPT4ge1xuXHRcdFx0Y29uc3QgbmFtZSA9IHJlbGF0aW9uc1tpbmRleF07XG5cdFx0XHR0aGlzLnNldChuYW1lIGFzIGtleW9mIFQsIDxhbnk+ZGF0YSk7XG5cdFx0fSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhbGwoKSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0QWxsKCk7XG5cdH1cblxuXHRhc3luYyBjcmVhdGUoZGF0YT86IFBhcnRpYWw8VD4pIHtcblx0XHRpZiAoZGF0YSkge1xuXHRcdFx0dGhpcy5maWxsKGRhdGEpO1xuXHRcdH1cblxuXHRcdHRoaXMuc2V0KCdjcmVhdGVkX2F0JywgbmV3IERhdGUoKS50b0pTT04oKSk7XG5cdFx0dGhpcy5zZXQoJ3VwZGF0ZWRfYXQnLCBuZXcgRGF0ZSgpLnRvSlNPTigpKTtcblxuXHRcdHRoaXMuY2FsbEV2ZW50KCdjcmVhdGluZycpLmNhbGxFdmVudCgnc2F2aW5nJyk7XG5cblx0XHRjb25zdCByZWYgPSB0aGlzLmdldENvbGxlY3Rpb24oKS5kb2MoKTtcblxuXHRcdGNvbnN0IHBheWxvYWQgPSB7XG5cdFx0XHQuLi50aGlzLndpdGhvdXRSZWxhdGlvbnMoKSxcblx0XHRcdGlkOiByZWYuaWQsXG5cdFx0fTtcblxuXHRcdGF3YWl0IHJlZi5zZXQocGF5bG9hZCk7XG5cblx0XHR0aGlzLmZvcmNlRmlsbChwYXlsb2FkKTtcblxuXHRcdHRoaXMuY2FsbEV2ZW50KCdjcmVhdGVkJykuY2FsbEV2ZW50KCdzYXZlZCcpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YXN5bmMgdXBkYXRlKGRhdGE/OiBQYXJ0aWFsPFQ+KSB7XG5cdFx0aWYgKGRhdGEpIHtcblx0XHRcdHRoaXMuZmlsbChkYXRhKTtcblx0XHR9XG5cdFx0Y29uc3Qgb2xkVXBkYXRlZEF0ID0gdGhpcy5nZXQoJ3VwZGF0ZWRfYXQnKTtcblx0XHR0cnkge1xuXHRcdFx0dGhpcy5jYWxsRXZlbnQoJ3VwZGF0aW5nJykuY2FsbEV2ZW50KCdzYXZpbmcnKTtcblx0XHRcdHRoaXMuc2V0KCd1cGRhdGVkX2F0JywgbmV3IERhdGUoKS50b0pTT04oKSk7XG5cblx0XHRcdGNvbnN0IGRhdGEgPSB0aGlzLndpdGhvdXRSZWxhdGlvbnMoKTtcblxuXHRcdFx0YXdhaXQgdGhpcy5nZXRDb2xsZWN0aW9uKCkuZG9jKGRhdGEuaWQpLnNldChkYXRhKTtcblxuXHRcdFx0dGhpcy5jYWxsRXZlbnQoJ3VwZGF0ZWQnKS5jYWxsRXZlbnQoJ3NhdmVkJyk7XG5cdFx0XHRyZXR1cm4gdGhpcztcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhpcy5zZXQoJ3VwZGF0ZWRfYXQnLCBvbGRVcGRhdGVkQXQpO1xuXHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0fVxuXHR9XG5cblx0aWQoKSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0KCdpZCcpIGFzIHN0cmluZztcblx0fVxuXG5cdHNhdmUoZGF0YT86IFBhcnRpYWw8VD4pIHtcblx0XHRpZiAoZGF0YSkge1xuXHRcdFx0dGhpcy5maWxsKGRhdGEpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5oYXMoJ2lkJykgPyB0aGlzLnVwZGF0ZSgpIDogdGhpcy5jcmVhdGUoKTtcblx0fVxuXG5cdHVuc2V0PEsgZXh0ZW5kcyBrZXlvZiBUPihrZXk6IEspIHtcblx0XHRkZWxldGUgdGhpcy5kYXRhW2tleV07XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRoYXM8SyBleHRlbmRzIGtleW9mIFQ+KGtleTogSykge1xuXHRcdHJldHVybiBrZXkgaW4gdGhpcy5kYXRhIHx8IHRoaXMuZ2V0KGtleSkgIT09IG51bGw7XG5cdH1cbn1cbiJdfQ==