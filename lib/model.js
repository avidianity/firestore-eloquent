"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Model = void 0;

var _collection = require("./collection");

var _hasEvent = require("./has-event");

var _db = require("./db");

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class Model extends _hasEvent.HasEvent {
  constructor(data) {
    super();

    _defineProperty(this, "fillables", void 0);

    _defineProperty(this, "data", {});

    _defineProperty(this, "type", Model);

    this.booting();
    this.fillables = this.fillable();

    if (!this.name || this.name.length === 0) {
      this.name = this.constructor.name.toLowerCase();
    }

    if (!('id' in this.data)) {
      this.data.id === '';
    }

    if (data !== undefined) {
      this.fill(data);
    }

    this.booted();
  }

  static createQueryBuilder() {
    return new this();
  }

  fillable() {
    return [];
  }

  booting() {}

  booted() {}

  entries() {
    return Object.entries(this.getData());
  }

  values() {
    return Object.values(this.getData());
  }

  keys() {
    return Object.keys(this.getData());
  }

  getTableName() {
    return this.name;
  }

  toJSON() {
    return this.getData();
  }

  toRawData() {
    return _objectSpread({}, this.data);
  }

  static make(data) {
    return new this(data);
  }

  async paginate(page, perPage) {
    try {
      let collection = this.getCollection();
      this.queries.forEach(query => {
        switch (query.method) {
          case 'where':
            const {
              operator,
              value
            } = query;
            collection = collection.where(query.key, operator, value);
            break;

          case 'whereIn':
            const {
              values
            } = query;
            values.forEach(value => {
              collection = collection.where(query.key, '==', value);
            });
            break;

          case 'whereNotIn':
            query.values.forEach(value => {
              collection = collection.where(query.key, '!=', value);
            });
            break;

          case 'limit':
            collection = collection.limit(query.amount);
            break;
        }
      });
      const snapshot = await collection.orderBy('id').startAt(perPage * (page - 1)).limit(perPage).get();
      const data = new _collection.Collection();
      snapshot.forEach(document => {
        const body = _objectSpread(_objectSpread({}, document.data()), {}, {
          id: document.id
        });

        const instance = new this.type();
        instance.forceFill(body);
        data.push(instance);
      });
      return data;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  async findOne(id) {
    try {
      const document = await this.getCollection().doc(id).get();

      if (!document.exists) {
        return null;
      }

      const body = _objectSpread(_objectSpread({}, document.data()), {}, {
        id: document.id
      });

      this.forceFill(body);
      return this;
    } catch (error) {
      console.error(error);
      return null;
    } finally {
      this.clearQueries();
    }
  }

  async findOneOrFail(id) {
    const model = await this.findOne(id);

    if (!model) {
      throw new Error('Model does not exist.');
    }

    return model;
  }

  getCollection() {
    return (0, _db.makeCollection)(this.getTableName());
  }

  fill(data) {
    for (const [key, value] of Object.entries(data)) {
      if (this.fillables.find(filler => filler === key) !== undefined || this.fillables.includes(key)) {
        this.set(key, value);
      }
    }

    return this;
  }

  forceFill(data) {
    for (const [key, value] of Object.entries(data)) {
      this.set(key, value);
    }

    return this;
  }

  async count() {
    const collection = await this.all();
    return collection.length;
  }

  async delete() {
    try {
      this.callEvent('deleting');
      let collection = this.getCollection();
      await collection.doc(this.id()).delete();
      this.callEvent('deleted');
      return;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  set(key, value) {
    this.data[key] = value;
    return this;
  }

  get(key) {
    if (!(key in this.data)) {
      return null;
    }

    const value = this.data[key];

    if (value instanceof Model) {
      return value.getData();
    } else if (value instanceof _collection.Collection) {
      return value.toJSON();
    } else if (Array.isArray(value)) {
      return value.map(item => {
        if (item instanceof Model) {
          return item.getData();
        }

        return item;
      });
    }

    return value;
  }

  getData() {
    const data = {};

    for (const key in this.data) {
      const value = this.data[key];

      if (value instanceof Model) {
        data[key] = value.getData();
      } else if (value instanceof _collection.Collection) {
        data[key] = value.toJSON();
      } else if (Array.isArray(value)) {
        data[key] = value.map(item => {
          if (item instanceof Model) {
            return item.getData();
          }

          return item;
        });
      } else {
        data[key] = value;
      }
    }

    return data;
  }

  async first() {
    const collection = await this.limit(1).getAll();

    if (collection.length > 0) {
      return collection[0];
    }

    return null;
  }

  async firstOrFail() {
    const item = await this.first();

    if (!item) {
      throw new Error('Model does not exist.');
    }

    return item;
  }

  async getAll() {
    try {
      let collection = this.getCollection();
      this.queries.forEach(query => {
        switch (query.method) {
          case 'where':
            const {
              operator,
              value
            } = query;
            collection = collection.where(query.key, operator, value);
            break;

          case 'whereIn':
            const {
              values
            } = query;
            values.forEach(value => {
              collection = collection.where(query.key, '==', value);
            });
            break;

          case 'whereNotIn':
            query.values.forEach(value => {
              collection = collection.where(query.key, '!=', value);
            });
            break;

          case 'limit':
            collection = collection.limit(query.amount);
            break;
        }
      });
      const snapshot = await collection.get();
      const data = new _collection.Collection();
      snapshot.forEach(document => {
        const body = _objectSpread(_objectSpread({}, document.data()), {}, {
          id: document.id
        });

        const instance = new this.type();
        instance.forceFill(body);
        data.push(instance);
      });
      return data;
    } catch (error) {
      throw error;
    } finally {
      this.clearQueries();
    }
  }

  withoutRelations() {
    const data = {};

    for (const key in this.data) {
      const value = this.data[key];

      if (value instanceof Model === false && value instanceof _collection.Collection === false) {
        data[key] = value;
      }
    }

    return data;
  }

  async load(relations) {
    const operations = relations.map(relation => this[relation]().get());
    const results = await Promise.all(operations);
    results.forEach((data, index) => {
      const name = relations[index];
      this.set(name, data);
    });
    return this;
  }

  all() {
    return this.getAll();
  }

  async create(data) {
    if (data) {
      this.fill(data);
    }

    this.set('created_at', new Date().toJSON());
    this.set('updated_at', new Date().toJSON());
    this.callEvent('creating').callEvent('saving');
    const ref = this.getCollection().doc();

    const payload = _objectSpread(_objectSpread({}, this.withoutRelations()), {}, {
      id: ref.id
    });

    await ref.set(payload);
    this.forceFill(payload);
    this.callEvent('created').callEvent('saved');
    return this;
  }

  async update(data) {
    if (data) {
      this.fill(data);
    }

    const oldUpdatedAt = this.get('updated_at');

    try {
      this.callEvent('updating').callEvent('saving');
      this.set('updated_at', new Date().toJSON());
      const data = this.withoutRelations();
      await this.getCollection().doc(data.id).set(data);
      this.callEvent('updated').callEvent('saved');
      return this;
    } catch (error) {
      this.set('updated_at', oldUpdatedAt);
      throw error;
    }
  }

  id() {
    return this.get('id');
  }

  save(data) {
    if (data) {
      this.fill(data);
    }

    return this.has('id') ? this.update() : this.create();
  }

  unset(key) {
    delete this.data[key];
    return this;
  }

  has(key) {
    return key in this.data || this.get(key) !== null;
  }

}

exports.Model = Model;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC50cyJdLCJuYW1lcyI6WyJNb2RlbCIsIkhhc0V2ZW50IiwiY29uc3RydWN0b3IiLCJkYXRhIiwiYm9vdGluZyIsImZpbGxhYmxlcyIsImZpbGxhYmxlIiwibmFtZSIsImxlbmd0aCIsInRvTG93ZXJDYXNlIiwiaWQiLCJ1bmRlZmluZWQiLCJmaWxsIiwiYm9vdGVkIiwiY3JlYXRlUXVlcnlCdWlsZGVyIiwiZW50cmllcyIsIk9iamVjdCIsImdldERhdGEiLCJ2YWx1ZXMiLCJrZXlzIiwiZ2V0VGFibGVOYW1lIiwidG9KU09OIiwidG9SYXdEYXRhIiwibWFrZSIsInBhZ2luYXRlIiwicGFnZSIsInBlclBhZ2UiLCJjb2xsZWN0aW9uIiwiZ2V0Q29sbGVjdGlvbiIsInF1ZXJpZXMiLCJmb3JFYWNoIiwicXVlcnkiLCJtZXRob2QiLCJvcGVyYXRvciIsInZhbHVlIiwid2hlcmUiLCJrZXkiLCJsaW1pdCIsImFtb3VudCIsInNuYXBzaG90Iiwib3JkZXJCeSIsInN0YXJ0QXQiLCJnZXQiLCJDb2xsZWN0aW9uIiwiZG9jdW1lbnQiLCJib2R5IiwiaW5zdGFuY2UiLCJ0eXBlIiwiZm9yY2VGaWxsIiwicHVzaCIsImVycm9yIiwiY2xlYXJRdWVyaWVzIiwiZmluZE9uZSIsImRvYyIsImV4aXN0cyIsImNvbnNvbGUiLCJmaW5kT25lT3JGYWlsIiwibW9kZWwiLCJFcnJvciIsImZpbmQiLCJmaWxsZXIiLCJpbmNsdWRlcyIsInNldCIsImNvdW50IiwiYWxsIiwiZGVsZXRlIiwiY2FsbEV2ZW50IiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXRlbSIsImZpcnN0IiwiZ2V0QWxsIiwiZmlyc3RPckZhaWwiLCJ3aXRob3V0UmVsYXRpb25zIiwibG9hZCIsInJlbGF0aW9ucyIsIm9wZXJhdGlvbnMiLCJyZWxhdGlvbiIsInJlc3VsdHMiLCJQcm9taXNlIiwiaW5kZXgiLCJjcmVhdGUiLCJEYXRlIiwicmVmIiwicGF5bG9hZCIsInVwZGF0ZSIsIm9s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QUsrRCxTQUFMLENBQWUsU0FBZixFQUEwQkEsU0FBMUIsQ0FBb0MsT0FBcEM7QUFDQSxhQUFPLElBQVA7QUFDQSxLQVZELENBVUUsT0FBT2hCLEtBQVAsRUFBYztBQUNmLFdBQUtZLEdBQUwsQ0FBUyxZQUFULEVBQXVCeUIsWUFBdkI7QUFDQSxZQUFNckMsS0FBTjtBQUNBO0FBQ0Q7O0FBRUR4QyxFQUFBQSxFQUFFLEdBQUc7QUFDSixXQUFPLEtBQUtnQyxHQUFMLENBQVMsSUFBVCxDQUFQO0FBQ0E7O0FBRUQ4QyxFQUFBQSxJQUFJLENBQUNyRixJQUFELEVBQW9CO0FBQ3ZCLFFBQUlBLElBQUosRUFBVTtBQUNULFdBQUtTLElBQUwsQ0FBVVQsSUFBVjtBQUNBOztBQUNELFdBQU8sS0FBS3NGLEdBQUwsQ0FBUyxJQUFULElBQWlCLEtBQUtILE1BQUwsRUFBakIsR0FBaUMsS0FBS0osTUFBTCxFQUF4QztBQUNBOztBQUVEUSxFQUFBQSxLQUFLLENBQW9CdEQsR0FBcEIsRUFBNEI7QUFDaEMsV0FBTyxLQUFLakMsSUFBTCxDQUFVaUMsR0FBVixDQUFQO0FBQ0EsV0FBTyxJQUFQO0FBQ0E7O0FBRURxRCxFQUFBQSxHQUFHLENBQW9CckQsR0FBcEIsRUFBNEI7QUFDOUIsV0FBT0EsR0FBRyxJQUFJLEtBQUtqQyxJQUFaLElBQW9CLEtBQUt1QyxHQUFMLENBQVNOLEdBQVQsTUFBa0IsSUFBN0M7QUFDQTs7QUEzWWdFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sbGVjdGlvbiB9IGZyb20gJy4vY29sbGVjdGlvbic7XG5pbXBvcnQgeyBIYXNFdmVudCB9IGZyb20gJy4vaGFzLWV2ZW50JztcbmltcG9ydCB7IEZpcmVzdG9yZUNvbGxlY3Rpb24sIEludGVyYWN0c1dpdGhSZWxhdGlvbnNoaXAsIE1vZGVsRGF0YSB9IGZyb20gJy4vY29udHJhY3RzJztcbmltcG9ydCB7IG1ha2VDb2xsZWN0aW9uIH0gZnJvbSAnLi9kYic7XG5cbmV4cG9ydCBjbGFzcyBNb2RlbDxUIGV4dGVuZHMgTW9kZWxEYXRhID0gYW55PiBleHRlbmRzIEhhc0V2ZW50PFQ+IHtcblx0cHJvdGVjdGVkIGZpbGxhYmxlczogQXJyYXk8c3RyaW5nPjtcblx0cHJvdGVjdGVkIGRhdGE6IFQgPSB7fSBhcyBUO1xuXHR0eXBlOiBhbnkgPSBNb2RlbDtcblxuXHRjb25zdHJ1Y3RvcihkYXRhPzogUGFydGlhbDxUPikge1xuXHRcdHN1cGVyKCk7XG5cdFx0dGhpcy5ib290aW5nKCk7XG5cdFx0dGhpcy5maWxsYWJsZXMgPSB0aGlzLmZpbGxhYmxlKCk7XG5cblx0XHRpZiAoIXRoaXMubmFtZSB8fCB0aGlzLm5hbWUubGVuZ3RoID09PSAwKSB7XG5cdFx0XHR0aGlzLm5hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWUudG9Mb3dlckNhc2UoKTtcblx0XHR9XG5cblx0XHRpZiAoISgnaWQnIGluIHRoaXMuZGF0YSkpIHtcblx0XHRcdHRoaXMuZGF0YS5pZCA9PT0gJyc7XG5cdFx0fVxuXHRcdGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdHRoaXMuZmlsbChkYXRhKTtcblx0XHR9XG5cdFx0dGhpcy5ib290ZWQoKTtcblx0fVxuXG5cdHN0YXRpYyBjcmVhdGVRdWVyeUJ1aWxkZXIoKSB7XG5cdFx0cmV0dXJuIG5ldyB0aGlzKCk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgZmlsbGFibGUoKTogQXJyYXk8c3RyaW5nPiB7XG5cdFx0cmV0dXJuIFtdO1xuXHR9XG5cblx0cHJvdGVjdGVkIGJvb3RpbmcoKSB7fVxuXG5cdHByb3RlY3RlZCBib290ZWQoKSB7fVxuXG5cdGVudHJpZXMoKSB7XG5cdFx0cmV0dXJuIE9iamVjdC5lbnRyaWVzKHRoaXMuZ2V0RGF0YSgpKTtcblx0fVxuXG5cdHZhbHVlcygpIHtcblx0XHRyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzLmdldERhdGEoKSk7XG5cdH1cblxuXHRrZXlzKCkge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmdldERhdGEoKSk7XG5cdH1cblxuXHRnZXRUYWJsZU5hbWUoKSB7XG5cdFx0cmV0dXJuIHRoaXMubmFtZTtcblx0fVxuXG5cdHRvSlNPTigpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXREYXRhKCk7XG5cdH1cblxuXHR0b1Jhd0RhdGEoKSB7XG5cdFx0cmV0dXJuIHsgLi4udGhpcy5kYXRhIH07XG5cdH1cblxuXHRzdGF0aWMgbWFrZShkYXRhPzogYW55KSB7XG5cdFx0cmV0dXJuIG5ldyB0aGlzKGRhdGEpO1xuXHR9XG5cblx0YXN5bmMgcGFnaW5hdGUocGFnZTogbnVtYmVyLCBwZXJQYWdlOiBudW1iZXIpOiBQcm9taXNlPENvbGxlY3Rpb248dGhpcywgVD4+IHtcblx0XHR0cnkge1xuXHRcdFx0bGV0IGNvbGxlY3Rpb246IEZpcmVzdG9yZUNvbGxlY3Rpb24gPSB0aGlzLmdldENvbGxlY3Rpb24oKTtcblx0XHRcdHRoaXMucXVlcmllcy5mb3JFYWNoKChxdWVyeSkgPT4ge1xuXHRcdFx0XHRzd2l0Y2ggKHF1ZXJ5Lm1ldGhvZCkge1xuXHRcdFx0XHRcdGNhc2UgJ3doZXJlJzpcblx0XHRcdFx0XHRcdGNvbnN0IHsgb3BlcmF0b3IsIHZhbHVlIH0gPSBxdWVyeTtcblx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLndoZXJlKHF1ZXJ5LmtleSwgb3BlcmF0b3IsIHZhbHVlKTtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgJ3doZXJlSW4nOlxuXHRcdFx0XHRcdFx0Y29uc3QgeyB2YWx1ZXMgfSA9IHF1ZXJ5O1xuXHRcdFx0XHRcdFx0dmFsdWVzLmZvckVhY2goKHZhbHVlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRcdFx0Y29sbGVjdGlvbiA9IGNvbGxlY3Rpb24ud2hlcmUocXVlcnkua2V5LCAnPT0nLCB2YWx1ZSk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgJ3doZXJlTm90SW4nOlxuXHRcdFx0XHRcdFx0cXVlcnkudmFsdWVzLmZvckVhY2goKHZhbHVlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRcdFx0Y29sbGVjdGlvbiA9IGNvbGxlY3Rpb24ud2hlcmUocXVlcnkua2V5LCAnIT0nLCB2YWx1ZSk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdGNhc2UgJ2xpbWl0Jzpcblx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmxpbWl0KHF1ZXJ5LmFtb3VudCk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0XHRjb25zdCBzbmFwc2hvdCA9IGF3YWl0IGNvbGxlY3Rpb25cblx0XHRcdFx0Lm9yZGVyQnkoJ2lkJylcblx0XHRcdFx0LnN0YXJ0QXQocGVyUGFnZSAqIChwYWdlIC0gMSkpXG5cdFx0XHRcdC5saW1pdChwZXJQYWdlKVxuXHRcdFx0XHQuZ2V0KCk7XG5cblx0XHRcdGNvbnN0IGRhdGEgPSBuZXcgQ29sbGVjdGlvbigpO1xuXHRcdFx0c25hcHNob3QuZm9yRWFjaCgoZG9jdW1lbnQpID0+IHtcblx0XHRcdFx0Y29uc3QgYm9keSA9IHtcblx0XHRcdFx0XHQuLi5kb2N1bWVudC5kYXRhKCksXG5cdFx0XHRcdFx0aWQ6IGRvY3VtZW50LmlkLFxuXHRcdFx0XHR9O1xuXHRcdFx0XHRjb25zdCBpbnN0YW5jZSA9IG5ldyB0aGlzLnR5cGUoKTtcblx0XHRcdFx0aW5zdGFuY2UuZm9yY2VGaWxsKGJvZHkpO1xuXHRcdFx0XHRkYXRhLnB1c2goaW5zdGFuY2UpO1xuXHRcdFx0fSk7XG5cdFx0XHRyZXR1cm4gZGF0YTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdHRoaXMuY2xlYXJRdWVyaWVzKCk7XG5cdFx0fVxuXHR9XG5cblx0YXN5bmMgZmluZE9uZShpZDogc3RyaW5nKTogUHJvbWlzZTx0aGlzIHwgbnVsbD4ge1xuXHRcdHRyeSB7XG5cdFx0XHRjb25zdCBkb2N1bWVudCA9IGF3YWl0IHRoaXMuZ2V0Q29sbGVjdGlvbigpLmRvYyhpZCkuZ2V0KCk7XG5cblx0XHRcdGlmICghZG9jdW1lbnQuZXhpc3RzKSB7XG5cdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBib2R5OiBhbnkgPSB7XG5cdFx0XHRcdC4uLmRvY3VtZW50LmRhdGEoKSxcblx0XHRcdFx0aWQ6IGRvY3VtZW50LmlkLFxuXHRcdFx0fTtcblxuXHRcdFx0dGhpcy5mb3JjZUZpbGwoYm9keSk7XG5cdFx0XHRyZXR1cm4gdGhpcztcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihlcnJvcik7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9IGZpbmFsbHkge1xuXHRcdFx0dGhpcy5jbGVhclF1ZXJpZXMoKTtcblx0XHR9XG5cdH1cblxuXHRhc3luYyBmaW5kT25lT3JGYWlsKGlkOiBzdHJpbmcpIHtcblx0XHRjb25zdCBtb2RlbCA9IGF3YWl0IHRoaXMuZmluZE9uZShpZCk7XG5cblx0XHRpZiAoIW1vZGVsKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01vZGVsIGRvZXMgbm90IGV4aXN0LicpO1xuXHRcdH1cblxuXHRcdHJldHVybiBtb2RlbDtcblx0fVxuXG5cdGdldENvbGxlY3Rpb24oKSB7XG5cdFx0cmV0dXJuIG1ha2VDb2xsZWN0aW9uKHRoaXMuZ2V0VGFibGVOYW1lKCkpO1xuXHR9XG5cblx0ZmlsbChkYXRhOiBQYXJ0aWFsPFQ+KSB7XG5cdFx0Zm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZGF0YSkpIHtcblx0XHRcdGlmICh0aGlzLmZpbGxhYmxlcy5maW5kKChmaWxsZXIpID0+IGZpbGxlciA9PT0ga2V5KSAhPT0gdW5kZWZpbmVkIHx8IHRoaXMuZmlsbGFibGVzLmluY2x1ZGVzKGtleSkpIHtcblx0XHRcdFx0dGhpcy5zZXQoa2V5IGFzIGtleW9mIFQsIHZhbHVlKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRmb3JjZUZpbGwoZGF0YTogUGFydGlhbDxUPikge1xuXHRcdGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XG5cdFx0XHR0aGlzLnNldChrZXkgYXMgYW55LCB2YWx1ZSk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YXN5bmMgY291bnQoKSB7XG5cdFx0Y29uc3QgY29sbGVjdGlvbiA9IGF3YWl0IHRoaXMuYWxsKCk7XG5cdFx0cmV0dXJuIGNvbGxlY3Rpb24ubGVuZ3RoO1xuXHR9XG5cblx0YXN5bmMgZGVsZXRlKCkge1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmNhbGxFdmVudCgnZGVsZXRpbmcnKTtcblx0XHRcdGxldCBjb2xsZWN0aW9uID0gdGhpcy5nZXRDb2xsZWN0aW9uKCk7XG5cdFx0XHRhd2FpdCBjb2xsZWN0aW9uLmRvYyh0aGlzLmlkKCkpLmRlbGV0ZSgpO1xuXHRcdFx0dGhpcy5jYWxsRXZlbnQoJ2RlbGV0ZWQnKTtcblxuXHRcdFx0cmV0dXJuO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9IGZpbmFsbHkge1xuXHRcdFx0dGhpcy5jbGVhclF1ZXJpZXMoKTtcblx0XHR9XG5cdH1cblxuXHRzZXQ8SyBleHRlbmRzIGtleW9mIFQ+KGtleTogSywgdmFsdWU6IFRbS10pIHtcblx0XHR0aGlzLmRhdGFba2V5XSA9IHZhbHVlO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0Z2V0PEsgZXh0ZW5kcyBrZXlvZiBUPihrZXk6IEspOiBUW0tdIHtcblx0XHRpZiAoIShrZXkgaW4gdGhpcy5kYXRhKSkge1xuXHRcdFx0cmV0dXJuIG51bGwgYXMgdW5rbm93biBhcyBUW0tdO1xuXHRcdH1cblx0XHRjb25zdCB2YWx1ZSA9IHRoaXMuZGF0YVtrZXldO1xuXG5cdFx0aWYgKHZhbHVlIGluc3RhbmNlb2YgTW9kZWwpIHtcblx0XHRcdHJldHVybiB2YWx1ZS5nZXREYXRhKCk7XG5cdFx0fSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENvbGxlY3Rpb24pIHtcblx0XHRcdHJldHVybiB2YWx1ZS50b0pTT04oKSBhcyBhbnk7XG5cdFx0fSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuXHRcdFx0cmV0dXJuIHZhbHVlLm1hcCgoaXRlbSkgPT4ge1xuXHRcdFx0XHRpZiAoaXRlbSBpbnN0YW5jZW9mIE1vZGVsKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGl0ZW0uZ2V0RGF0YSgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdHJldHVybiBpdGVtO1xuXHRcdFx0fSkgYXMgYW55O1xuXHRcdH1cblxuXHRcdHJldHVybiB2YWx1ZTtcblx0fVxuXG5cdGdldERhdGEoKTogVCB7XG5cdFx0Y29uc3QgZGF0YTogYW55ID0ge307XG5cblx0XHRmb3IgKGNvbnN0IGtleSBpbiB0aGlzLmRhdGEpIHtcblx0XHRcdGNvbnN0IHZhbHVlID0gdGhpcy5kYXRhW2tleV07XG5cblx0XHRcdGlmICh2YWx1ZSBpbnN0YW5jZW9mIE1vZGVsKSB7XG5cdFx0XHRcdGRhdGFba2V5XSA9IHZhbHVlLmdldERhdGEoKTtcblx0XHRcdH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBDb2xsZWN0aW9uKSB7XG5cdFx0XHRcdGRhdGFba2V5XSA9IHZhbHVlLnRvSlNPTigpO1xuXHRcdFx0fSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuXHRcdFx0XHRkYXRhW2tleV0gPSB2YWx1ZS5tYXAoKGl0ZW0pID0+IHtcblx0XHRcdFx0XHRpZiAoaXRlbSBpbnN0YW5jZW9mIE1vZGVsKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gaXRlbS5nZXREYXRhKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJldHVybiBpdGVtO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGRhdGFba2V5XSA9IHZhbHVlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBkYXRhO1xuXHR9XG5cblx0YXN5bmMgZmlyc3QoKSB7XG5cdFx0Y29uc3QgY29sbGVjdGlvbiA9IGF3YWl0IHRoaXMubGltaXQoMSkuZ2V0QWxsKCk7XG5cblx0XHRpZiAoY29sbGVjdGlvbi5sZW5ndGggPiAwKSB7XG5cdFx0XHRyZXR1cm4gY29sbGVjdGlvblswXTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdGFzeW5jIGZpcnN0T3JGYWlsKCkge1xuXHRcdGNvbnN0IGl0ZW0gPSBhd2FpdCB0aGlzLmZpcnN0KCk7XG5cblx0XHRpZiAoIWl0ZW0pIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignTW9kZWwgZG9lcyBub3QgZXhpc3QuJyk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGl0ZW07XG5cdH1cblxuXHRhc3luYyBnZXRBbGwoKTogUHJvbWlzZTxDb2xsZWN0aW9uPHRoaXMsIFQ+PiB7XG5cdFx0dHJ5IHtcblx0XHRcdGxldCBjb2xsZWN0aW9uOiBGaXJlc3RvcmVDb2xsZWN0aW9uID0gdGhpcy5nZXRDb2xsZWN0aW9uKCk7XG5cdFx0XHR0aGlzLnF1ZXJpZXMuZm9yRWFjaCgocXVlcnkpID0+IHtcblx0XHRcdFx0c3dpdGNoIChxdWVyeS5tZXRob2QpIHtcblx0XHRcdFx0XHRjYXNlICd3aGVyZSc6XG5cdFx0XHRcdFx0XHRjb25zdCB7IG9wZXJhdG9yLCB2YWx1ZSB9ID0gcXVlcnk7XG5cdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi53aGVyZShxdWVyeS5rZXksIG9wZXJhdG9yLCB2YWx1ZSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICd3aGVyZUluJzpcblx0XHRcdFx0XHRcdGNvbnN0IHsgdmFsdWVzIH0gPSBxdWVyeTtcblx0XHRcdFx0XHRcdHZhbHVlcy5mb3JFYWNoKCh2YWx1ZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLndoZXJlKHF1ZXJ5LmtleSwgJz09JywgdmFsdWUpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICd3aGVyZU5vdEluJzpcblx0XHRcdFx0XHRcdHF1ZXJ5LnZhbHVlcy5mb3JFYWNoKCh2YWx1ZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLndoZXJlKHF1ZXJ5LmtleSwgJyE9JywgdmFsdWUpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRjYXNlICdsaW1pdCc6XG5cdFx0XHRcdFx0XHRjb2xsZWN0aW9uID0gY29sbGVjdGlvbi5saW1pdChxdWVyeS5hbW91bnQpO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXHRcdFx0Y29uc3Qgc25hcHNob3QgPSBhd2FpdCBjb2xsZWN0aW9uLmdldCgpO1xuXHRcdFx0Y29uc3QgZGF0YSA9IG5ldyBDb2xsZWN0aW9uKCk7XG5cblx0XHRcdHNuYXBzaG90LmZvckVhY2goKGRvY3VtZW50KSA9PiB7XG5cdFx0XHRcdGNvbnN0IGJvZHkgPSB7XG5cdFx0XHRcdFx0Li4uZG9jdW1lbnQuZGF0YSgpLFxuXHRcdFx0XHRcdGlkOiBkb2N1bWVudC5pZCxcblx0XHRcdFx0fTtcblx0XHRcdFx0Y29uc3QgaW5zdGFuY2UgPSBuZXcgdGhpcy50eXBlKCk7XG5cdFx0XHRcdGluc3RhbmNlLmZvcmNlRmlsbChib2R5KTtcblx0XHRcdFx0ZGF0YS5wdXNoKGluc3RhbmNlKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRyZXR1cm4gZGF0YTtcblx0XHR9IGNhdGNoIChlcnJvcikge1xuXHRcdFx0dGhyb3cgZXJyb3I7XG5cdFx0fSBmaW5hbGx5IHtcblx0XHRcdHRoaXMuY2xlYXJRdWVyaWVzKCk7XG5cdFx0fVxuXHR9XG5cblx0d2l0aG91dFJlbGF0aW9ucygpOiBUIHtcblx0XHRjb25zdCBkYXRhOiBhbnkgPSB7fTtcblxuXHRcdGZvciAoY29uc3Qga2V5IGluIHRoaXMuZGF0YSkge1xuXHRcdFx0Y29uc3QgdmFsdWUgPSB0aGlzLmRhdGFba2V5XTtcblxuXHRcdFx0aWYgKHZhbHVlIGluc3RhbmNlb2YgTW9kZWwgPT09IGZhbHNlICYmIHZhbHVlIGluc3RhbmNlb2YgQ29sbGVjdGlvbiA9PT0gZmFsc2UpIHtcblx0XHRcdFx0ZGF0YVtrZXldID0gdmFsdWU7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGRhdGE7XG5cdH1cblxuXHRhc3luYyBsb2FkKHJlbGF0aW9uczogQXJyYXk8c3RyaW5nPikge1xuXHRcdGNvbnN0IG9wZXJhdGlvbnMgPSByZWxhdGlvbnMubWFwKChyZWxhdGlvbikgPT4gKCh0aGlzIGFzIGFueSlbcmVsYXRpb25dKCkgYXMgSW50ZXJhY3RzV2l0aFJlbGF0aW9uc2hpcDx0aGlzPikuZ2V0KCkpO1xuXHRcdGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChvcGVyYXRpb25zKTtcblx0XHRyZXN1bHRzLmZvckVhY2goKGRhdGEsIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCBuYW1lID0gcmVsYXRpb25zW2luZGV4XTtcblx0XHRcdHRoaXMuc2V0KG5hbWUgYXMga2V5b2YgVCwgPGFueT5kYXRhKTtcblx0XHR9KTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGFsbCgpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXRBbGwoKTtcblx0fVxuXG5cdGFzeW5jIGNyZWF0ZShkYXRhPzogVCkge1xuXHRcdGlmIChkYXRhKSB7XG5cdFx0XHR0aGlzLmZpbGwoZGF0YSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5zZXQoJ2NyZWF0ZWRfYXQnLCBuZXcgRGF0ZSgpLnRvSlNPTigpKTtcblx0XHR0aGlzLnNldCgndXBkYXRlZF9hdCcsIG5ldyBEYXRlKCkudG9KU09OKCkpO1xuXG5cdFx0dGhpcy5jYWxsRXZlbnQoJ2NyZWF0aW5nJykuY2FsbEV2ZW50KCdzYXZpbmcnKTtcblxuXHRcdGNvbnN0IHJlZiA9IHRoaXMuZ2V0Q29sbGVjdGlvbigpLmRvYygpO1xuXG5cdFx0Y29uc3QgcGF5bG9hZCA9IHtcblx0XHRcdC4uLnRoaXMud2l0aG91dFJlbGF0aW9ucygpLFxuXHRcdFx0aWQ6IHJlZi5pZCxcblx0XHR9O1xuXG5cdFx0YXdhaXQgcmVmLnNldChwYXlsb2FkKTtcblxuXHRcdHRoaXMuZm9yY2VGaWxsKHBheWxvYWQpO1xuXG5cdFx0dGhpcy5jYWxsRXZlbnQoJ2NyZWF0ZWQnKS5jYWxsRXZlbnQoJ3NhdmVkJyk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhc3luYyB1cGRhdGUoZGF0YT86IFBhcnRpYWw8VD4pIHtcblx0XHRpZiAoZGF0YSkge1xuXHRcdFx0dGhpcy5maWxsKGRhdGEpO1xuXHRcdH1cblx0XHRjb25zdCBvbGRVcGRhdGVkQXQgPSB0aGlzLmdldCgndXBkYXRlZF9hdCcpO1xuXHRcdHRyeSB7XG5cdFx0XHR0aGlzLmNhbGxFdmVudCgndXBkYXRpbmcnKS5jYWxsRXZlbnQoJ3NhdmluZycpO1xuXHRcdFx0dGhpcy5zZXQoJ3VwZGF0ZWRfYXQnLCBuZXcgRGF0ZSgpLnRvSlNPTigpKTtcblxuXHRcdFx0Y29uc3QgZGF0YSA9IHRoaXMud2l0aG91dFJlbGF0aW9ucygpO1xuXG5cdFx0XHRhd2FpdCB0aGlzLmdldENvbGxlY3Rpb24oKS5kb2MoZGF0YS5pZCkuc2V0KGRhdGEpO1xuXG5cdFx0XHR0aGlzLmNhbGxFdmVudCgndXBkYXRlZCcpLmNhbGxFdmVudCgnc2F2ZWQnKTtcblx0XHRcdHJldHVybiB0aGlzO1xuXHRcdH0gY2F0Y2ggKGVycm9yKSB7XG5cdFx0XHR0aGlzLnNldCgndXBkYXRlZF9hdCcsIG9sZFVwZGF0ZWRBdCk7XG5cdFx0XHR0aHJvdyBlcnJvcjtcblx0XHR9XG5cdH1cblxuXHRpZCgpIHtcblx0XHRyZXR1cm4gdGhpcy5nZXQoJ2lkJykgYXMgc3RyaW5nO1xuXHR9XG5cblx0c2F2ZShkYXRhPzogUGFydGlhbDxUPikge1xuXHRcdGlmIChkYXRhKSB7XG5cdFx0XHR0aGlzLmZpbGwoZGF0YSk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLmhhcygnaWQnKSA/IHRoaXMudXBkYXRlKCkgOiB0aGlzLmNyZWF0ZSgpO1xuXHR9XG5cblx0dW5zZXQ8SyBleHRlbmRzIGtleW9mIFQ+KGtleTogSykge1xuXHRcdGRlbGV0ZSB0aGlzLmRhdGFba2V5XTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGhhczxLIGV4dGVuZHMga2V5b2YgVD4oa2V5OiBLKSB7XG5cdFx0cmV0dXJuIGtleSBpbiB0aGlzLmRhdGEgfHwgdGhpcy5nZXQoa2V5KSAhPT0gbnVsbDtcblx0fVxufVxuIl19